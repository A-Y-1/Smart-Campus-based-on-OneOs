## 开发板基本配置

### 1.文件系统挂载

​		sd0是基于spi2设备而创建的，需要先在ONEOSCUBE配置spi2。这里默认工程都是配置好的，不需要设置了。但是挂载是需要手动进行的，代码如下：

```c
#include <vfs_fs.h>										//单独使用只需要这个头文件
int sdmmc( void ){     
    /* mount the file system from tf card */
    if (vfs_mount("sd0", "/", "fat", 0, 0) == 0){
        os_kprintf("Filesystem initialized!\n");
    }
    else{
            os_kprintf("Failed to initialize filesystem!\n");
        }
        return 0;
}
SH_CMD_EXPORT(sdmmc, sdmmc, "sdmmc");					//添加到控制台（需要其他头文件）
```

​		文件挂载ONEOS提供了专门的.c文件，只需要挂载一次就可以正常使用，但是这个程序需要在控制台手动执行（需要一些其他头文件，使用demo文件夹中给出的sdmmc_test）。或者在main中调用在每次启动时挂载。

### 2.网络连接

​		Molink组件可以实现开发板连接网络。在Components→ Network→ Molink路径下配置WIFI模组。设置WIFI名和密码。并需要在tools下打开调试。

```shell
    (Top) → Components→ Network→ Molink→ Enable IoT modules support → Module→ WiFi Modules Support→ ESP8266 → ESP8266 Confi cfg
                                                                                                                OneOS Configuration
    [*] Enable ESP8266 Module Object Auto Create
    (uart1) ESP8266 Interface Device Name								//串口一是Molink
    (115200) ESP8266 Interface Device Rate (NEW)
    (512)   The maximum length of AT command data accepted (NEW)
    [*]     Enable ESP8266 Module Auto Connect (NEW)
    (ssid) ESP8266 Connect AP SSID (NEW)								//WIFI名
    (password) ESP8266 Connect AP Password (NEW)						//密码
    [*] Enable ESP8266 Module General Operates (NEW)
    -*- Enable ESP8266 Module WiFi Operates (NEW)
    [*] Enable ESP8266 Module Ping Operates (NEW)
    [*] Enable ESP8266 Module Ifconfig Operates (NEW)
    -*- Enable ESP8266 Module Network TCP/IP Operates (NEW)
    [*] Enable ESP8266 Module BSD Socket Operates						//打开
    [ ] Enable ESP8266 Module Hardware Control Operates (NEW)
    ---------------------------------------------------------------------------------------------
    (Top) → Components→ Network→ Molink→ Enable IoT modules support → Tool                                                     cfg
                                                                                                                OneOS Configuration
    [*] Enable AT module network debug functions
    [*]     Enable molink ifconfig features (NEW)
    [*]     Enable molink ping features (NEW)
    (50)        The maximum times of molink ping cmd config (NEW)
    [*]     Enable molink socket stat features (NEW)
    [ ]     Enable molink iperf feature (NEW)
```

​		保存配置，下载程序到开发板，可以使用ifconfig命令查看WIFI是否连接成功。

### 3.MQTT连接OneNET

​		通过MQTT协议，开发板可以实现与onenet平台连接并通信。进入Onenet，在全部服务中找到==MQTT物联网套件==，后续的连接是在该套件内进行的，不是Onenet Studio。进入MQTT物联网套件后可以创建产品以及创建设备。可以得到产品ID，用户ID，产品KEY，设备ID，设备KEY，接下来的连接需要用到。

​		在Components→ Cloud→ OneNET→ MQTT kit下配置MQTT

```shell
    (Top) → Components→ Cloud→ OneNET→ MQTT kit                                                                                 cfg
                                                                                                                OneOS Configuration
    [*] Enable onenet mqtt-kit
    (128)   The publish data buffer length (NEW)
    [ ]     Enable mqtt-kit TLS encrypt (NEW)
    [*]     Enable onenet device auto register
```

​		在OS的OneOS-V2.2.0\components\cloud\onenet\mqtt-kit\mqtts_device文件夹下会产生测试程序onenet_device_sample.c，对应的.h文件里面需要设置ID。

```c
//onenet_device_sample.h
#define USER_PRODUCT_ID "516520"
#define USER_ACCESS_KEY "KPDKIzM8dyFKF/OVThXV/fGN43yEaxp4+74BK0FL7pU="
#define USER_DEVICE_NAME                                                                                               \
    "STM32L475"             /*use characters, numbers or symbols like '_' or '-',                              \
                                    no longer than 64, can use device serial num*/
#define USER_KEEPALIVE_INTERVAL 240 /*onenent heart interval 10~1800s*/
#define USER_PUBLISH_INTERVAL   10  /*user onenet data upload interval*/

#ifndef ONENET_MQTTS_USING_AUTO_REGISTER
#define USER_DEVICE_ID "943273514"
#define USER_KEY       "uME4rWyH7eJK43gSJFDQ4JsS+u8Vx/DCi43vYSRQ5Z4="
#endif
```

​		下载程序后，输入指令onenet_mqtts_device_start，启动设备，generate_onenet_publish_data_cycle就可以发数据了。

